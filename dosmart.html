import React, { useState, useEffect, useRef } from 'react';
// Firebase imports - ဒီ service တွေက user management နဲ့ database အတွက် လိုအပ်ပါတယ်
import { initializeApp } from 'firebase/app';
import { 
    getAuth, 
    signInWithPopup, 
    GoogleAuthProvider, 
    signInWithEmailAndPassword, 
    signOut, 
    onAuthStateChanged 
} from 'firebase/auth';
import { 
    getFirestore, 
    collection, 
    onSnapshot, 
    addDoc, 
    deleteDoc, 
    doc,
    query,
    where,
    getDocs
} from 'firebase/firestore';

// --- Firebase Configuration ---
// အရေးကြီး !!! - ဒီနေရာမှာ သင့်ရဲ့ Firebase Project က Configuration တန်ဖိုးအစစ်တွေကို ထည့်ပါ။
// Vercel မှာ deploy လုပ်တဲ့အခါ ဒီတန်ဖိုးတွေကို Environment Variables အဖြစ် ပြောင်းထည့်ရပါမယ်။
const firebaseConfig = {
    apiKey: "YOUR_API_KEY", // <-- Vercel မှာ NEXT_PUBLIC_FIREBASE_API_KEY အဖြစ်ထည့်ပါ
    authDomain: "YOUR_AUTH_DOMAIN", // <-- Vercel မှာ NEXT_PUBLIC_FIREBASE_AUTH_DOMAIN အဖြစ်ထည့်ပါ
    projectId: "YOUR_PROJECT_ID", // <-- Vercel မှာ NEXT_PUBLIC_FIREBASE_PROJECT_ID အဖြစ်ထည့်ပါ
    storageBucket: "YOUR_STORAGE_BUCKET", // <-- Vercel မှာ NEXT_PUBLIC_FIREBASE_STORAGE_BUCKET အဖြစ်ထည့်ပါ
    messagingSenderId: "YOUR_MESSAGING_SENDER_ID", // <-- Vercel မှာ NEXT_PUBLIC_FIREBASE_MESSAGING_SENDER_ID အဖြစ်ထည့်ပါ
    appId: "YOUR_APP_ID" // <-- Vercel မှာ NEXT_PUBLIC_FIREBASE_APP_ID အဖြစ်ထည့်ပါ
};


// --- Admin Account Configuration ---
// ဒီနေရာမှာ Admin ရဲ့ email ကို သတ်မှတ်ပါ
const ADMIN_EMAIL = "admin@dosmart.com";

// --- Main Application Component ---
export default function DoSmartApp() {
    // Firebase services state
    const [auth, setAuth] = useState(null);
    const [db, setDb] = useState(null);

    // User and authentication state
    const [user, setUser] = useState(null);
    const [userRole, setUserRole] = useState(null); // 'admin', 'user', or 'unauthorized'
    const [loading, setLoading] = useState(true);

    // Initialize Firebase and set up auth listener
    useEffect(() => {
        try {
            const app = initializeApp(firebaseConfig);
            const authInstance = getAuth(app);
            const dbInstance = getFirestore(app);
            setAuth(authInstance);
            setDb(dbInstance);

            const unsubscribe = onAuthStateChanged(authInstance, async (currentUser) => {
                setLoading(true);
                if (currentUser) {
                    setUser(currentUser);
                    // Check user role
                    if (currentUser.email === ADMIN_EMAIL) {
                        setUserRole('admin');
                    } else {
                        // Check if user is in the allowedUsers collection
                        const q = query(collection(dbInstance, "allowedUsers"), where("email", "==", currentUser.email));
                        const querySnapshot = await getDocs(q);
                        if (!querySnapshot.empty) {
                            setUserRole('user');
                        } else {
                            setUserRole('unauthorized');
                        }
                    }
                } else {
                    setUser(null);
                    setUserRole(null);
                }
                setLoading(false);
            });

            return () => unsubscribe();
        } catch (error) {
            console.error("Firebase initialization error:", error);
            // Firebase config မှားနေရင် ဒီမှာ error ပြပါလိမ့်မယ်
            setLoading(false);
        }
    }, []);

    const handleLogout = () => {
        signOut(auth);
    };

    // Loading screen
    if (loading) {
        return <div className="min-h-screen flex items-center justify-center bg-gray-100"><div className="text-xl font-semibold">Loading...</div></div>;
    }

    // Render components based on user role
    return (
        <div className="min-h-screen bg-gray-50 font-sans">
            {user && (
                 <header className="bg-white shadow-md p-4 flex justify-between items-center">
                    <div>
                        <h1 className="text-2xl font-bold text-gray-800">Do Smart App</h1>
                        <p className="text-sm text-gray-500">Welcome, {user.displayName || user.email}</p>
                    </div>
                    <button onClick={handleLogout} className="bg-red-500 text-white px-4 py-2 rounded-lg hover:bg-red-600 transition duration-300">Logout</button>
                </header>
            )}

            <main className="p-4 md:p-8">
                {!user && <LoginPage auth={auth} />}
                {userRole === 'admin' && <AdminDashboard db={db} />}
                {userRole === 'user' && <AppFeatures />}
                {userRole === 'unauthorized' && <UnauthorizedAccess />}
            </main>
        </div>
    );
}

// --- Authentication Component ---
const LoginPage = ({ auth }) => {
    const [email, setEmail] = useState('');
    const [password, setPassword] = useState('');
    const [error, setError] = useState('');

    const handleAdminLogin = async (e) => {
        e.preventDefault();
        setError('');
        if (!auth) {
            setError("Authentication service is not ready.");
            return;
        }
        try {
            await signInWithEmailAndPassword(auth, email, password);
        } catch (err) {
            setError("Admin login failed. Please check your credentials.");
        }
    };

    const handleGoogleLogin = async () => {
        setError('');
        if (!auth) {
            setError("Authentication service is not ready.");
            return;
        }
        const provider = new GoogleAuthProvider();
        try {
            await signInWithPopup(auth, provider);
        } catch (err) {
            setError("Google sign-in failed. Please try again.");
        }
    };

    return (
        <div className="max-w-md mx-auto mt-10 bg-white p-8 rounded-xl shadow-lg">
            <h2 className="text-3xl font-bold text-center text-gray-800 mb-6">Welcome to Do Smart</h2>
            {error && <p className="bg-red-100 text-red-700 p-3 rounded-md mb-4">{error}</p>}
            
            <div className="mb-8 p-4 border rounded-lg">
                <h3 className="text-xl font-semibold text-gray-700 mb-2">Admin Login</h3>
                <form onSubmit={handleAdminLogin}>
                    <input type="email" value={email} onChange={(e) => setEmail(e.target.value)} placeholder="Admin Email" className="w-full p-2 border rounded mb-2" required />
                    <input type="password" value={password} onChange={(e) => setPassword(e.target.value)} placeholder="Password" className="w-full p-2 border rounded mb-4" required />
                    <button type="submit" className="w-full bg-indigo-600 text-white py-2 rounded-lg hover:bg-indigo-700">Login as Admin</button>
                </form>
            </div>
            
            <div className="text-center">
                 <h3 className="text-xl font-semibold text-gray-700 mb-4">User Login</h3>
                <button onClick={handleGoogleLogin} className="bg-white border border-gray-300 text-gray-700 px-6 py-3 rounded-lg shadow-sm hover:shadow-md flex items-center justify-center w-full">
                    <img src="https://www.google.com/images/branding/googlelogo/1x/googlelogo_color_272x92dp.png" alt="Google icon" className="w-6 h-6 mr-3"/>
                    Sign in with Google
                </button>
            </div>
        </div>
    );
};

// --- Admin Panel Component ---
const AdminDashboard = ({ db }) => {
    const [allowedUsers, setAllowedUsers] = useState([]);
    const [newUserEmail, setNewUserEmail] = useState('');

    useEffect(() => {
        if (!db) return;
        const q = collection(db, "allowedUsers");
        const unsubscribe = onSnapshot(q, (querySnapshot) => {
            const usersList = querySnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
            setAllowedUsers(usersList);
        });
        return () => unsubscribe();
    }, [db]);

    const addUser = async () => {
        if (newUserEmail && !allowedUsers.some(u => u.email === newUserEmail)) {
            await addDoc(collection(db, "allowedUsers"), { email: newUserEmail });
            setNewUserEmail('');
        }
    };

    const removeUser = async (id) => {
        await deleteDoc(doc(db, "allowedUsers", id));
    };

    return (
        <div className="max-w-4xl mx-auto bg-white p-6 rounded-xl shadow-lg">
            <h2 className="text-2xl font-bold mb-4">Admin Dashboard - User Management</h2>
            <div className="flex mb-4">
                <input 
                    type="email" 
                    value={newUserEmail} 
                    onChange={(e) => setNewUserEmail(e.target.value)} 
                    placeholder="Enter user's Gmail to admit" 
                    className="flex-grow p-2 border rounded-l-lg"
                />
                <button onClick={addUser} className="bg-green-500 text-white px-4 py-2 rounded-r-lg hover:bg-green-600">Admit User</button>
            </div>
            <div>
                <h3 className="text-xl font-semibold mb-2">Admitted Users:</h3>
                <ul className="space-y-2">
                    {allowedUsers.map(user => (
                        <li key={user.id} className="flex justify-between items-center p-3 bg-gray-100 rounded-lg">
                            <span>{user.email}</span>
                            <button onClick={() => removeUser(user.id)} className="bg-red-500 text-white px-3 py-1 text-sm rounded-md hover:bg-red-600">Cancel Access</button>
                        </li>
                    ))}
                </ul>
            </div>
        </div>
    );
};

// --- Unauthorized Access Component ---
const UnauthorizedAccess = () => (
    <div className="max-w-2xl mx-auto text-center bg-white p-8 rounded-xl shadow-lg">
        <h2 className="text-2xl font-bold text-red-600 mb-4">Access Denied</h2>
        <p className="text-gray-700">Your Google account is not authorized to use this application. Please contact the administrator to get access.</p>
    </div>
);


// --- Main App Features Component ---
const AppFeatures = () => {
    const [geminiKey, setGeminiKey] = useState('');
    const [isKeyValid, setIsKeyValid] = useState(false);
    const [keyError, setKeyError] = useState('');
    const [step, setStep] = useState('enter_key'); // 'enter_key', 'select_method', 'record', 'processing', 'result', 'completed'
    
    // Recording states
    const mediaRecorderRef = useRef(null);
    const [recordingStatus, setRecordingStatus] = useState('inactive'); // inactive, recording, paused
    const [audioChunks, setAudioChunks] = useState([]);
    const [audioUrl, setAudioUrl] = useState(null);

    // Processing states
    const [transcript, setTranscript] = useState('');
    const [correctedTranscript, setCorrectedTranscript] = useState('');
    const [isLoading, setIsLoading] = useState(false);

    // --- Gemini API Functions ---
    // NOTE: Gemini API speech-to-text isn't directly available on the client-side for audio files.
    // This needs a backend (Vercel Serverless Function) to process.
    // The following functions are placeholders to simulate the workflow.
    
    const validateApiKey = async () => {
        if (!geminiKey) {
            setKeyError('Please enter an API key.');
            return;
        }
        setKeyError('');
        setIsLoading(true);
        // SIMULATION: In a real app, you'd make a test call to the Gemini API.
        setTimeout(() => {
            setIsLoading(false);
            setIsKeyValid(true);
            setStep('select_method');
        }, 1000);
    };

    const processAudioToText = async (audioBlob) => {
        setIsLoading(true);
        setStep('processing');
        // SIMULATION: This function would send the audioBlob to your backend,
        // which then sends it to the Gemini API.
        console.log("Simulating audio processing...", audioBlob);
        setTimeout(() => {
            setTranscript("ဤသည်မှာ နမူနာ စာသားဖြစ်ပါသည်။ အသံသွင်းခြင်းမှ ပြောင်းလဲထားသည်။");
            setIsLoading(false);
            setStep('result');
        }, 3000);
    };

    const checkGrammar = async () => {
        setIsLoading(true);
        // SIMULATION: Send the transcript to Gemini for grammar correction.
        console.log("Simulating grammar check...");
        setTimeout(() => {
            setCorrectedTranscript("ဤသည်မှာ နမူနာ စာသား ဖြစ်ပါသည်။ အသံသွင်းခြင်းမှ ပြောင်းလဲထားသည်။ (သဒ္ဒါစစ်ပြီး)");
            setIsLoading(false);
        }, 2000);
    };
    
    // --- Recording Logic ---
    const startRecording = async () => {
        try {
            const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
            mediaRecorderRef.current = new MediaRecorder(stream);
            mediaRecorderRef.current.ondataavailable = (event) => {
                setAudioChunks(prev => [...prev, event.data]);
            };
            mediaRecorderRef.current.start();
            setRecordingStatus('recording');
        } catch (err) {
            console.error("Error accessing microphone:", err);
            alert("Could not access microphone. Please check your browser permissions.");
        }
    };

    const stopRecording = () => {
        if (mediaRecorderRef.current && recordingStatus === 'recording') {
            mediaRecorderRef.current.stop();
            mediaRecorderRef.current.onstop = () => {
                const audioBlob = new Blob(audioChunks, { type: 'audio/webm' });
                const url = URL.createObjectURL(audioBlob);
                setAudioUrl(url);
                setAudioChunks([]);
                processAudioToText(audioBlob);
            };
            setRecordingStatus('inactive');
        }
    };
    
    const handleFileUpload = (event) => {
        const file = event.target.files[0];
        if (file) {
            const url = URL.createObjectURL(file);
            setAudioUrl(url);
            processAudioToText(file);
        }
    };

    const copyToClipboard = (text) => {
        navigator.clipboard.writeText(text);
        alert('Copied to clipboard!');
    };
    
    const saveToDoc = () => {
        // This requires Google Drive API integration, which is complex.
        // We'll simulate the success message.
        alert('Simulating save to Google Drive... Saved successfully!');
        setStep('completed');
    };


    // --- Render logic based on step ---
    
    if (step === 'enter_key') {
        return (
            <div className="max-w-lg mx-auto bg-white p-8 rounded-xl shadow-lg">
                <h3 className="text-xl font-bold mb-4">Enter Gemini API Key</h3>
                <p className="text-sm text-gray-600 mb-4">Your API key is required to use the app's features. It is stored securely in your browser.</p>
                <input 
                    type="password" 
                    value={geminiKey} 
                    onChange={(e) => setGeminiKey(e.target.value)} 
                    placeholder="Your Gemini API Key" 
                    className="w-full p-2 border rounded mb-2"
                />
                {keyError && <p className="text-red-500 text-sm mb-4">{keyError}</p>}
                <button onClick={validateApiKey} disabled={isLoading} className="w-full bg-blue-500 text-white py-2 rounded-lg hover:bg-blue-600 disabled:bg-blue-300">
                    {isLoading ? 'Validating...' : 'Continue'}
                </button>
            </div>
        );
    }
    
    if (step === 'select_method') {
        return (
             <div className="max-w-lg mx-auto text-center bg-white p-8 rounded-xl shadow-lg">
                <h3 className="text-xl font-bold mb-6">How would you like to start?</h3>
                <div className="flex justify-center gap-4">
                    <label className="w-1/2 cursor-pointer bg-green-500 text-white p-6 rounded-lg text-center hover:bg-green-600">
                        Upload Audio File
                        <input type="file" accept="audio/*" onChange={handleFileUpload} className="hidden" />
                    </label>
                    <button onClick={() => setStep('record')} className="w-1/2 bg-purple-500 text-white p-6 rounded-lg hover:bg-purple-600">
                        Record Audio
                    </button>
                </div>
            </div>
        );
    }

    if (step === 'record') {
        return (
            <div className="max-w-lg mx-auto text-center bg-white p-8 rounded-xl shadow-lg">
                 <h3 className="text-xl font-bold mb-4">Audio Recorder</h3>
                 <div className="flex justify-center items-center gap-4 h-24">
                    {recordingStatus === 'inactive' && <button onClick={startRecording} className="bg-red-500 text-white px-8 py-4 rounded-full font-bold">Record</button>}
                    {recordingStatus === 'recording' && <button onClick={stopRecording} className="bg-gray-700 text-white px-8 py-4 rounded-full font-bold animate-pulse">Stop</button>}
                 </div>
                 <p className="text-sm text-gray-500 mt-4">Press 'Record' to start and 'Stop' when you're finished.</p>
            </div>
        );
    }

    if (step === 'processing') {
        return (
            <div className="max-w-lg mx-auto text-center bg-white p-8 rounded-xl shadow-lg">
                <h3 className="text-2xl font-bold mb-4">Processing...</h3>
                <p>Your audio is being converted to text. Please wait.</p>
                {/* A simple spinner */}
                <div className="animate-spin rounded-full h-12 w-12 border-b-2 border-blue-500 mx-auto mt-4"></div>
            </div>
        );
    }
    
    if (step === 'result') {
        return (
             <div className="max-w-2xl mx-auto bg-white p-8 rounded-xl shadow-lg">
                 <h3 className="text-2xl font-bold mb-4">Your Transcript</h3>
                 {audioUrl && <audio controls src={audioUrl} className="w-full mb-4"></audio>}
                 <div className="p-4 border rounded-md bg-gray-50 mb-4 min-h-[100px]">{transcript}</div>
                 
                 {!correctedTranscript && (
                    <button onClick={checkGrammar} disabled={isLoading} className="w-full bg-indigo-500 text-white py-2 rounded-lg hover:bg-indigo-600 disabled:bg-indigo-300">
                        {isLoading ? 'Checking...' : 'သဒ္ဒါစစ်မယ် (Check Grammar)'}
                    </button>
                 )}

                 {correctedTranscript && (
                    <div>
                        <h4 className="text-xl font-bold mb-2 text-green-600">Corrected Text</h4>
                        <div className="p-4 border rounded-md bg-green-50 mb-4 min-h-[100px]">{correctedTranscript}</div>
                        <div className="flex gap-4">
                            <button onClick={() => copyToClipboard(correctedTranscript)} className="w-1/2 bg-blue-500 text-white py-2 rounded-lg hover:bg-blue-600">Copy</button>
                            <button onClick={saveToDoc} className="w-1/2 bg-green-500 text-white py-2 rounded-lg hover:bg-green-600">Save to Doc</button>
                        </div>
                    </div>
                 )}
            </div>
        );
    }
    
    if (step === 'completed') {
        return (
            <div className="max-w-lg mx-auto text-center bg-white p-8 rounded-xl shadow-lg">
                <h3 className="text-2xl font-bold text-green-600 mb-4">Success!</h3>
                <p className="text-lg mb-6">သင် အသံသွင်းတာ စာလုံးစစ်တာ ပြီးမြောက်သွားပါပြီ။ ဂုဏ်ယူပါတယ်</p>
                <button onClick={() => setStep('select_method')} className="bg-blue-500 text-white px-6 py-2 rounded-lg hover:bg-blue-600">
                    Start Another Task
                </button>
            </div>
        );
    }

    return null; // Should not be reached
}

